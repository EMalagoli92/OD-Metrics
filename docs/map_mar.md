# Mean Average Precision (mAP)

## What is mAP?
**Mean Average Precision (mAP)** is a widely used evaluation metric in object detection.

## How to calculate mAP?
<p align="center">
<img src="../assets/images/map_1.png" alt="drawing" width="500"/></p>

The calculation of **mAP** involves the **predictions** generated by the object detection model and the corresponding ground-truth annotations.

### Predictions
Each prediction of an object detector consists of the following components:

- **Class** $\hat{c} \in \mathbb{N}_{\leq C}^+$, where $C \in \mathbb{N}^+$ is the total number of classes;
- **Bounding Box** $\hat{\textbf{B}} \in \mathbb{R}^4$, specifying the location of the detected object;
- **Confidence Score** $\hat{s} \in [0, 1]$, indicating the model's confidence in the prediction.

Each detection can be represented as:
$$ \hat{\textbf{y}} = ( \hat{c}, \hat{\textbf{B}}, \hat{s} ).$$

### Ground Truths
Ground-truth annotations provide the reference data against which predictions are evaluated. Each ground-truth annotation consist of the followinf components:

- **Class** $c \in \mathbb{N}_{\leq C}^+$, i.e, the actual class label of the object;
- **Bounding Box** $\textbf{B} \in \mathbb{R}^4$, i.e, the actual location of the object.

Each ground-truth object can be represented as:
$$\textbf{y} = ( c, \textbf{B} ). $$

The computation of **mAP** involves:

- a set of $G$ ground-truth objects:
$$Y = \{(c_i, \textbf{B}_i\}_{i=1,\ldots,G} $$
- a set of $D$ predictions:
$$\hat{Y} = \{(\hat{c}_i, \hat{\textbf{B}}_i, \hat{s}_i\}_{i=1,\ldots,D} $$


### Precision and Recall
To compute **Precision ($\text{P}_\bar{c}$)** and **Recall ($\text{R}_\bar{c}$)** for a fixed class $\bar{c} \in \mathbb{N}_{\leq C}^+$, let's define:

- **True Positives ($\text{TP}_\bar{c}$)**: predictions $\hat{\textbf{y}} = ( \hat{c}, \hat{\textbf{B}}, \hat{s} )$ that meet the following criteria:
	- the predicted class matches the ground-truth class ($\hat{c} = \bar{c}$);
	- the **IoU** between the predicted and ground-truth bounding boxes is greater than or equal to a threshold $\tau_{\text{IoU}}$;
	- the confidence score $\hat{s}$ is greater than or equal to a confidence threshold $\tau_{s} (\hat{s} \geq \tau_{s})$. 

Formally, the definition of $\text{TP}_\bar{c}$ depend on $\tau_{\text{IoU}}$ and $\tau_{s}$:
$$\text{TP}_{\bar{c}}(\tau_{s}, \tau_{\text{IoU}}) = \{ \hat{\textbf{y}} = ( \hat{c}, \hat{\textbf{B}}, \hat{s} ) \in \hat{Y} \mid \exists \;y = ( \bar{c}, \textbf{B} ) \in Y: \hat{c} = \bar{c} \wedge \text{IoU}( \textbf{B}, \hat{\textbf{B}} ) \geq \tau_{\text{IoU}} \wedge \hat{s} \geq \tau_{s} \}. $$

Thus, we can define **Precision ($\text{P}_\bar{c}$)** as:
$$ \text{P}_{\bar{c}}(\tau_{s}, \tau_{\text{IoU}}) = \frac{\text{TP}_{\bar{c}}(\tau_{s}, \tau_{\text{IoU}})}{\text{TP}_{\bar{c}}(\tau_{s}, \tau_{\text{IoU}}) + \text{FP}_{\bar{c}}(\tau_{\text{c}}, \tau_{\text{IoU}})} = \frac{|\text{TP}_{\bar{c}}(\tau_{s}, \tau_{\text{IoU}})|}{|\hat{Y}_{\bar{c}, \tau_{s}}|}$$
where $\hat{Y}_{\bar{c}, \tau_{s}} = \{\hat{y} = ( \hat{c}, \hat{\textbf{B}}, \hat{s} ) \in \hat{Y} \mid \hat{c} = \bar{c} \wedge \hat{s} \geq \tau_{s}\}$.

Similarly for the **Recall ($\text{R}_\bar{c}$)**:
$$ \text{R}_{\bar{c}}(\tau_{s}, \tau_{\text{IoU}}) = \frac{\text{TP}_{\bar{c}}(\tau_{s}, \tau_{\text{IoU}})}{\text{TP}_{\bar{c}}(\tau_{s}, \tau_{\text{IoU}}) + \text{FN}_{\bar{c}}(\tau_{s}, \tau_{\text{IoU}})} = \frac{|\text{TP}_{\bar{c}}(\tau_{\text{c}}, \tau_{\text{IoU}})|}{|Y_{\bar{c}}|},$$
where $Y_{\bar{c}} = \{ y \in Y \mid c = \bar{c} \}$.

## Average Precision and Mean Average Precision
For a specific class $\bar{c}$ and IoU threhsold $\bar{\tau}_{IoU}$, the **Average Precision** $\text{AP}_{\bar{c}}@[\bar{\tau}_{IoU}]$ is a metric based on the area under a $\text{P}_{\bar{c}}(\tau_{s}, \bar{\tau}_{\text{IoU}})\times \text{R}_{\bar{c}}(\tau_{s}, \bar{\tau}_{\text{IoU}})$ curve.<br>
In large datasets, it is useful to have a unique metric that is able to represent the exactness of the detections among all $C$ classes. For such cases, the mean average precision $\text{mAP}@[\bar{\tau}_{\text{IoU}}]$ is computed, which is simply:
$$\text{mAP}@[\bar{\tau}_{\text{IoU}}] = \frac{1}{C}\sum_{c=1}^C \text{AP}_{c}@[\bar{\tau}_{\text{IoU}}] $$

This area is in practice replaced with a finite sum using certain recall values and different interpolation methods.

One starts by ordering the $K$ different confidence scores output by the detector:

$$T_{\bar{c}} = \{ \tau_{s_k}, k \in \mathbb{N}_{\leq K}^+ \mid \tau_{s_i} > \tau_{s_j} \; \forall i > j\}$$

Interpolated Precision:

$$\tilde{P}_{\bar{c}}(x, \bar{\tau}_{IoU}) = \max_{j \in \mathbb{N}_{\leq K}^+ \mid R_{\bar{c}}(\tau_{s_j}, \bar{\tau}_{IoU}) \geq x} P_{\bar{c}}(\tau_{s_j}, \bar{\tau}_{IoU})$$



$N$-Point Interpolation. In this case the sequence $T_{\bar{c}}$ is chosen such that the corresponding sequence ${R_\bar{c}(\tau_{s_k}, \bar{\tau}_{IoU})}$ is equally spaced in the interval $[0,1]$, that is:

$$R_{\bar{c}}(\tau_{s_k}, \bar{\tau}_{IoU}) = \frac{N - k}{N -1}, \; \; k \in \mathbb{N}^+_{\leq N}$$

and thus:

$$ AP_{\bar{c}}@[\bar{\tau}_{IoU}] = \frac{1}{N} \sum_{k=1}^N  \tilde{P}_{\bar{c}}(\frac{N - k}{N -1}, \bar{\tau}_{IoU}) $$

Popular choices are $N=11$ or $N=101$.

In all-point interpolation:

$$ AP_{\bar{c}}@[\bar{\tau}_{IoU}] = \sum_{k=0}^{K} (R_\bar{c}(\tau_{s_k}, \bar{\tau}_{IoU}) - R_\bar{c}(\tau_{s_{k+1}}, \bar{\tau}_{IoU})) \tilde{P}_{\bar{c}}(R_\bar{c}(\tau_{s_k}, \bar{\tau}_{IoU}), \bar{\tau}_{IoU}) $$

with $\tau_{s_0} = 0$, $R_\bar{c}(\tau_{s_0}, \bar{\tau}_{IoU}) = 1$, $\tau_{s_{K+1}} = 1$, $R_\bar{c}(\tau_{s_{K+1}}, \bar{\tau}_{IoU}) = 0$.


## Example
Suppose to consider to classes, so $C=2$ and the following $\hat{Y}$.

| Id |  c | IoU  | s  |
|----|---|---|---|
|  a  | 1  | 0.86  | 0.90  |
|  b  |  1 | 0.65  |  0.95 |
|  c  |  1 | 0.44  |  0.7 |
|  d  |  1 | 0.32  |  0.8 |
|  e  |  1 | 0.88  |  0.7 |
|  f  | 2  | 0.48  | 0.82  |
|  g  |  2 | 0.98  |  0.97 |
|  h  |  2 | 0.45  |  0.64 |
|  i  |  2 | 0.67  |  0.63 |
|  l  |  2 | 0.73  |  0.52 |

Now fix the class $\bar{c}=1$ and $\bar{\tau}_{IoU} = 0.5$.
Then:

$$T_{1} = \{ 0.95, 0.90, 0.8, 0.7 \}$$

| Id |  c | IoU  | s  | IoU > 0.5 |
|----|---|---|---|---|
|  b  |  1 | 0.65  |  0.95 | True |
|  a  | 1  | 0.86  | 0.90  | True |
|  d  |  1 | 0.32  |  0.8 | False |
|  c  |  1 | 0.44  |  0.7 | False |
|  e  |  1 | 0.88  |  0.7 | True |

then:

| $\tau_{s}$ |  $Y_{1}$  | $\hat{Y}_{1, \tau_s}$  | $TP_{1}(\tau_s, 0.5)$ | $P_1(\tau_s, 0.5)$ | $R_1(\tau_s, 0.5)$ |
|----|---|---|---|---|---|
| 0.95 | 5 | 1 | 1 | 1.0 | 0.2
| 0.9 | 5 | 2 | 2 | 1.0 | 0.4
| 0.8 | 5 | 3 | 2 | 0.67 | 0.4
| 0.7 | 5 | 5 | 3 | 0.6 | 0.6

So

<div  style="width:1000px;height:600px">            <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_SVG"></script><script type="text/javascript">if (window.MathJax && window.MathJax.Hub && window.MathJax.Hub.Config) {window.MathJax.Hub.Config({SVG: {font: "STIX-Web"}});}</script>                <script type="text/javascript">window.PlotlyConfig = {MathJaxConfig: 'local'};</script>
        <script charset="utf-8" src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>                <div id="da71e593-e8de-4708-858a-059610a5b444" class="plotly-graph-div" style="height:100%; width:100%;"></div>            <script type="text/javascript">                                    window.PLOTLYENV=window.PLOTLYENV || {};                                    if (document.getElementById("da71e593-e8de-4708-858a-059610a5b444")) {                    Plotly.newPlot(                        "da71e593-e8de-4708-858a-059610a5b444",                        [{"hovertemplate":"x=%{x}\u003cbr\u003ey=%{y}\u003cextra\u003e\u003c\u002fextra\u003e","legendgroup":"","marker":{"color":"rgba(99, 110, 250, 1)","symbol":"circle","size":15},"mode":"markers","name":"","orientation":"v","showlegend":false,"x":[0.2,0.4,0.4,0.6],"xaxis":"x","y":[1.0,1.0,0.67,0.6],"yaxis":"y","type":"scatter"}],                        {"template":{"data":{"histogram2dcontour":[{"type":"histogram2dcontour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"choropleth":[{"type":"choropleth","colorbar":{"outlinewidth":0,"ticks":""}}],"histogram2d":[{"type":"histogram2d","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmap":[{"type":"heatmap","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmapgl":[{"type":"heatmapgl","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"contourcarpet":[{"type":"contourcarpet","colorbar":{"outlinewidth":0,"ticks":""}}],"contour":[{"type":"contour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"surface":[{"type":"surface","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"mesh3d":[{"type":"mesh3d","colorbar":{"outlinewidth":0,"ticks":""}}],"scatter":[{"fillpattern":{"fillmode":"overlay","size":10,"solidity":0.2},"type":"scatter"}],"parcoords":[{"type":"parcoords","line":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolargl":[{"type":"scatterpolargl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"bar":[{"error_x":{"color":"#2a3f5f"},"error_y":{"color":"#2a3f5f"},"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"bar"}],"scattergeo":[{"type":"scattergeo","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolar":[{"type":"scatterpolar","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"histogram":[{"marker":{"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"histogram"}],"scattergl":[{"type":"scattergl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatter3d":[{"type":"scatter3d","line":{"colorbar":{"outlinewidth":0,"ticks":""}},"marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattermapbox":[{"type":"scattermapbox","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterternary":[{"type":"scatterternary","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattercarpet":[{"type":"scattercarpet","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"carpet":[{"aaxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"baxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"type":"carpet"}],"table":[{"cells":{"fill":{"color":"#EBF0F8"},"line":{"color":"white"}},"header":{"fill":{"color":"#C8D4E3"},"line":{"color":"white"}},"type":"table"}],"barpolar":[{"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"barpolar"}],"pie":[{"automargin":true,"type":"pie"}]},"layout":{"autotypenumbers":"strict","colorway":["#636efa","#EF553B","#00cc96","#ab63fa","#FFA15A","#19d3f3","#FF6692","#B6E880","#FF97FF","#FECB52"],"font":{"color":"#2a3f5f"},"hovermode":"closest","hoverlabel":{"align":"left"},"paper_bgcolor":"white","plot_bgcolor":"#E5ECF6","polar":{"bgcolor":"#E5ECF6","angularaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"radialaxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"ternary":{"bgcolor":"#E5ECF6","aaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"baxis":{"gridcolor":"white","linecolor":"white","ticks":""},"caxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"coloraxis":{"colorbar":{"outlinewidth":0,"ticks":""}},"colorscale":{"sequential":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"sequentialminus":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"diverging":[[0,"#8e0152"],[0.1,"#c51b7d"],[0.2,"#de77ae"],[0.3,"#f1b6da"],[0.4,"#fde0ef"],[0.5,"#f7f7f7"],[0.6,"#e6f5d0"],[0.7,"#b8e186"],[0.8,"#7fbc41"],[0.9,"#4d9221"],[1,"#276419"]]},"xaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"yaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"scene":{"xaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"yaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"zaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2}},"shapedefaults":{"line":{"color":"#2a3f5f"}},"annotationdefaults":{"arrowcolor":"#2a3f5f","arrowhead":0,"arrowwidth":1},"geo":{"bgcolor":"white","landcolor":"#E5ECF6","subunitcolor":"white","showland":true,"showlakes":true,"lakecolor":"white"},"title":{"x":0.05},"mapbox":{"style":"light"}}},"xaxis":{"anchor":"y","domain":[0.0,1.0],"title":{"text":"$\\Large{R_{1}(\\cdot, 0.5)}$"},"range":[-0.05,1.05],"gridcolor":"rgba(175,178,184,255)"},"yaxis":{"anchor":"x","domain":[0.0,1.0],"title":{"text":"$\\Large{P_{1}(\\cdot, 0.5)}$"},"range":[-0.05,1.05],"autorange":false,"gridcolor":"rgba(175,178,184,255)"},"legend":{"tracegroupgap":0},"margin":{"t":60},"shapes":[{"line":{"color":"rgba(99, 110, 250, 1)","dash":"dash","width":3},"type":"line","x0":0.2,"x1":0.2,"y0":0,"y1":1.0},{"line":{"color":"rgba(99, 110, 250, 1)","dash":"dash","width":3},"type":"line","x0":0.4,"x1":0.4,"y0":0,"y1":1.0},{"line":{"color":"rgba(99, 110, 250, 1)","dash":"dash","width":3},"type":"line","x0":0.4,"x1":0.4,"y0":0,"y1":0.67},{"line":{"color":"rgba(99, 110, 250, 1)","dash":"dash","width":3},"type":"line","x0":0.6,"x1":0.6,"y0":0,"y1":0.6}],"title":{"text":"Precision - Recall curve - Class: 1","y":0.99,"x":0.5,"xanchor":"center","yanchor":"top"},"font":{"family":"Arial","size":15,"color":"rgba(191,192,198,255)"},"plot_bgcolor":"rgba(0, 0, 0, 0)","paper_bgcolor":"rgba(0, 0, 0, 0)"},                        {"responsive": true}                    )                };                            </script>        </div>

## References
